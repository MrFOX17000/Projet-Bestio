{% extends 'base.html.twig' %}

{% block title %}Forum - Question{% endblock %}

{% block body %}
<h1 class="d-flex justify-content-center mb-20">Discussion</h1>
<div class="separator"></div>
<div class="d-flex flex-column align-items-center" style="background:transparent;">
    {# Carte principale de la question #}
    <div class="block mb-20 question-detail-card position-relative">
        <div class="d-flex justify-content-between align-items-center mb-10">
            <h2 class="d-flex">{{ question.titreQuestion }}</h2>
            {% set photo = attribute(question.author, 'photo') ?? null %}
            {% if photo %}
                {% set avatarUrl = photo starts with('/') ? asset(photo) : asset('uploads/avatar/' ~ photo) %}
            {% else %}
                {% set avatarUrl = asset('images/profil.webp') %}
            {% endif %}
            <a href="{{ path('user', {'id': question.author.id}) }}" class="avatar-link" title="Voir le profil de {{ question.author.pseudo ?? question.author.email }}">
                <img src="{{ avatarUrl }}" alt="Avatar de {{ question.author.pseudo ?? 'utilisateur' }}" class="avatar-img">
            </a>
        </div>
        <p class="question-text mb-20">{{ question.description }}</p>
        <small>Posée par <strong>{{ question.author.pseudo }}</strong> le {{ question.createdAt|date('d/m/Y à H:i') }}</small>
            {% if question.locked == true %}
                <i class="fa-solid fa-lock"></i>
            {% else %}
                <i class="fa-solid fa-unlock"></i>
            {% endif %}
        {# Bouton de Verrouillage/Déverouillage #}
            {% if app.user == question.author or is_granted('ROLE_ADMIN')  %}
                <form class ="lock-question-form" method="post" action="{{ path(question.locked ? 'unlock_question' : 'lock_question', {id: question.id}) }}">  {# On vérifie le statut du champ "Locked" dans l'entité topic pour l'affichage du bouton #} 
                    <button class="lock-question" type="submit">
                        {{ question.locked ? 'Déverrouiller' : 'Verrouiller' }} 
                    </button>
                </form> 
            {% endif %}
    </div>

    {# Liste des commentaires #}
    <div class="commentaires-wrapper" style="width:100%; max-width:700px;">
    <div class="separator"></div>
        <h2 class="d-flex justify-content-center mb-20">Commentaires</h2>
        {% if commentaires|length == 0 %}
            <div class="lien-question">
                <p>Aucun commentaire pour cette question.<br> Soyez le premier à en poster un !</p>
            </div>
        {% else %}
            <div style="display:flex; flex-direction:column; gap:18px;">
            {% for commentaire in commentaires %}
                <div class="comment-card">
                    <div class="comment-header">
                        <div class="comment-user">
                        {% set photo = attribute(commentaire.author, 'photo') ?? null %}
                        {% if photo %}
                            {% set avatarUrl = photo starts with('/') ? asset(photo) : asset('uploads/avatar/' ~ photo) %}
                        {% else %}
                            {% set avatarUrl = asset('images/profil.webp') %}
                        {% endif %}
                        <a href="{{ path('user', {'id': commentaire.author.id}) }}" class="avatar-link" title="Voir le profil de {{ commentaire.author.pseudo ?? commentaire.author.email }}">
                            <img src="{{ avatarUrl }}" alt="Avatar de {{ commentaire.author.pseudo ?? 'utilisateur' }}" class="avatar-img">
                        </a>
                            <span class="font-weight-bold" style="color:var(--gray-dark);">{{ commentaire.author.pseudo }}</span>
                        </div>
                        <span class="comment-meta">{{ commentaire.createdAtComm|date('d/m/Y à H:i') }}</span>
                    </div>
                    <p class="comment-content">{{ commentaire.contenu }}</p>
                     {% if app.user == commentaire.author or is_granted('ROLE_ADMIN')  %}
                        <form class ="delete-commentaire" method="post" action="{{ path('delete_commentaire', {id: commentaire.id}) }}";
                            <input type="hidden" name="_method" value="DELETE">
                        <button class="btn-delete-commentaire" type="submit"> <i class="fa-solid fa-trash"></i> </button>
                    </form>  
                {% endif %}
                </div>
            {% endfor %}
            </div>
        {% endif %}
    </div>

    <div class="pagination">
        {{ knp_pagination_render(commentaires) }}
    </div>

    <div style="width:100%; max-width:700px;">
        <div class="separator"></div>
    </div>
    {# Formulaire d'ajout de commentaire #}
   <div class="block">
        <h2 class="d-flex pb-30 justify-content-center">Ajouter un commentaire</h2>

        {% if app.user %}
            {% if canComment %}
                {% if question.locked == true %}
                    <p class="d-flex justify-content-center gray-dark">Ce sujet est verrouillé.</p>
                {% elseif app.user.banned %}
                    <p class="d-flex justify-content-center gray-dark">Vous ne pouvez pas ajouter de posts.</p>
                {% else %}
                    {{ form_start(formComm, {attr: {class: 'd-flex flex-column'}}) }}
                        <div class="form-row">
                            {{ form_label(formComm.contenu) }}
                            {{ form_widget(formComm.contenu, {attr: {rows: 5}}) }}
                            {{ form_errors(formComm.contenu) }}
                        </div>
                        <div class="d-flex justify-content-center">
                            <button type="submit" class="btn btn-primary-stroke">Publier</button>
                        </div>
                    {{ form_end(formComm) }}
                {% endif %}
            {% else %}
                <p class="d-flex justify-content-center gray-dark">
                    Vous êtes l’auteur de cette question, vous ne pouvez pas y répondre.
                </p>
            {% endif %}
        {% else %}
            <p class="info">Vous devez être connecté pour répondre à cette question ! <small> <a href="{{ path('connexion') }}">Se connecter</a> </small></p>
        {% endif %}
    </div>
</div>
{% endblock %}